#!/usr/bin/env bash

# Close any open System Preferences panes, to prevent them from overriding
# settings weâ€™re about to change
osascript -e 'tell application "iTerm2" to quit'

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

###############################################################################
# Git                                                                         #
###############################################################################

source .gitsetup

###############################################################################
# iTerm                                                                       #
###############################################################################

# Install iTerm
(curl "https://iterm2.com/downloads/stable/iTerm2-3_3_9.zip" > "$HOME/Downloads/iTerm2.zip" && cd "$HOME/Downloads/" && unzip "$HOME/Downloads/iTerm2.zip" -d "/Applications/")

# Copy iTerm settings and theme + set theme
mkdir -p ~/.iterm/
rsync --exclude ".DS_Store" -avh --no-perms resources/apps/iTerm/. ~/.iterm/
open ~/.iterm/1ockwood.itermcolors

###############################################################################
# zsh                                                                         #
###############################################################################

# Install newer zsh
resources/install/zsh-5.7.1/configure && make && make test && sudo make install

# Make zsh default shell
chsh -s $(which zsh)

# Install Oh My Zsh
(curl "https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh" > "$HOME/Downloads/install.sh" && cd "$HOME/Downloads/" && sh install.sh; rm install.sh)

# Install Antigen
curl -L git.io/antigen > $HOME/antigen.zsh

# Source helper dotfiles
echo '\n# Source helper dotfiles' >> ~/.zshrc
echo 'for file in $HOME/.{aliases,exports,extra,functions,antigenrc}; do' >> ~/.zshrc
echo '	[ -r "$file" ] && [ -f "$file" ] && source "$file";' >> ~/.zshrc
echo 'done' >> ~/.zshrc
echo 'unset file;' >> ~/.zshrc

# Edit .zshrc to hide user@hostname prompt
echo '\n# Hide user@hostname in prompt' >> ~/.zshrc
echo 'prompt_context(){}' >> ~/.zshrc

###############################################################################
# nvm                                                                         #
###############################################################################

# Install nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.2/install.sh | zsh
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

# Install latest node and alias to default
nvm install node
nvm alias default node
